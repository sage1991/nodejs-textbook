{% extends "layout.html" %}

{% block content %}
<h1>GIF 채팅방</h1>
<fieldset>
    <legend>채팅방 목록</legend>
    <table>
        <thead>
            <tr>
                <th>방 제목</th>
                <th>종류</th>
                <th>허용 인원</th>
                <th>방장</th>
            </tr>
        </thead>
        <tbody>
            {% for room in rooms %}
            <tr data-id="{{room._id}}">
                <td>{{room.title}}</td>
                <td>{{"비밀방" if room.password else "공개방"}}</td>
                <td>{{room.max}}</td>
                <td style="color: {{room.owner}}">{{room.owner}}</td>
                <td>
                    <button
                        class="join-btn"
                        data-id="{{room._id}}"
                        data-password="{{'true' if room.password else 'false'}}"
                    >
                        입장
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="error-message">{{error}}</div>
    <a href="/room">채팅방 생성</a>
</fieldset>
{% endblock %}

{% block script %}
<script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
<script>
    // room namespace
    const socket = io.connect("ws://localhost:3030/room", {
      transports: ["websocket"],
    })

    socket.on("connect", () => {
      console.log("websocket connected")
    })

    const navigateToChatRoom = ({ target }) => {
      const { dataset } = target
      if (dataset.password === "false") {
        location.href = `/room/${dataset.id}`
        return
      }
      const pw = prompt("비밀 번호를 입력 하세요.")
      location.href = `/room/${dataset.id}?password=${pw}`
    }

    // 방 추가 이벤트
    socket.on("newRoom", ({ _id, title, password, max, owner }) => {
      const tr = document.createElement("tr")
      tr.dataset.id = _id

      let td = document.createElement("td")
      td.textContent = title
      tr.appendChild(td)

      td = document.createElement("td")
      td.textContent = password ? "비밀방" : "공개방"
      tr.appendChild(td)

      td = document.createElement("td")
      td.textContent = max
      tr.appendChild(td)

      td = document.createElement("td")
      td.style.color = owner
      td.textContent = owner
      tr.appendChild(td)

      td = document.createElement("td")
      const button = document.createElement("button")
      button.className = "join-btn"
      button.textContent = "입장"
      button.dataset.password = password ? "true" : "false"
      button.dataset.id = _id
      button.addEventListener("click", navigateToChatRoom)
      td.appendChild(button)
      tr.appendChild(td)

      document.querySelector("table tbody").appendChild(tr)
    })

    // 방 제거 이벤트
    socket.on("removeRoom", (_id) => {
      document.querySelectorAll("tbody tr").forEach((tr) => {
        if (tr.dataset.id === _id) {
          tr.parentNode.removeChild(tr)
        }
      })
    })

    document.querySelectorAll(".join-btn").forEach((button) => {
      button.addEventListener("click", navigateToChatRoom)
    })
</script>
<script>
    window.onload = () => {
      const url = new URL(location.href)
      const error = url.searchParams.get("error")
      if (error) {
        alert(error)
      }
    }
</script>
{% endblock %}
